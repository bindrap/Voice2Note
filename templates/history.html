{% extends "base.html" %}

{% block title %}Processing History{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h2>Processing History</h2>
        <a href="/" class="btn btn-primary">+ New Video</a>
    </div>

    {% if videos %}
    <div class="video-list">
        {% for video in videos %}
        <div class="video-card" data-video-id="{{ video.id }}" data-status="{{ video.processing_status }}">
            <div class="video-info">
                <h3 class="video-title">{{ video.title }}</h3>
                {% if video.creator %}
                <p class="creator">{{ video.creator }}</p>
                {% endif %}
                <div class="meta-info">
                    {% if video.duration %}
                    <span class="badge">‚è±Ô∏è {{ (video.duration // 60) }} min</span>
                    {% endif %}
                    {% if video.source_url %}
                    <span class="badge">
                        <a href="{{ video.source_url }}" target="_blank" style="color: inherit; text-decoration: none;" title="Open source URL">
                            üîó YouTube
                        </a>
                    </span>
                    {% endif %}
                    <span class="badge">üìÖ {{ video.processed_date }}</span>

                    <!-- Only show status badge for actively processing videos -->
                    {% if video.processing_status and video.processing_status in ['pending', 'extracting', 'transcribing', 'generating'] %}
                    <span class="badge status-badge status-{{ video.processing_status }}">
                        {{ video.processing_status | capitalize }}
                    </span>
                    {% endif %}
                </div>

                <!-- Progress bar ONLY for actively processing videos -->
                {% if video.processing_status and video.processing_status in ['pending', 'extracting', 'transcribing', 'generating'] %}
                <div class="video-progress">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <small class="progress-text"></small>
                </div>
                {% endif %}
            </div>
            <div class="video-actions">
                {% if video.notes_id %}
                <!-- Completed videos with notes -->
                <a href="/notes/{{ video.id }}" class="btn btn-sm btn-primary">View Notes</a>
                <a href="/download/{{ video.id }}" class="btn btn-sm btn-secondary">Download</a>
                <button onclick="deleteVideo({{ video.id }})" class="btn btn-sm btn-delete" title="Delete video and notes">
                    Delete
                </button>
                {% elif video.processing_status in ['pending', 'extracting', 'transcribing', 'generating'] %}
                <!-- Processing videos - show cancel -->
                <button onclick="cancelProcessing({{ video.id }})" class="btn btn-sm btn-cancel" title="Cancel processing">
                    Cancel
                </button>
                {% elif video.processing_status in ['failed', 'cancelled'] %}
                <!-- Failed/Cancelled videos - show restart and delete -->
                {% if video.source_type == 'youtube' %}
                <button onclick="restartProcessing({{ video.id }})" class="btn btn-sm btn-primary" title="Restart processing">
                    Restart
                </button>
                {% endif %}
                <button onclick="deleteVideo({{ video.id }})" class="btn btn-sm btn-delete" title="Delete video">
                    Delete
                </button>
                {% else %}
                <!-- Default/Unknown status - allow deletion -->
                <button onclick="deleteVideo({{ video.id }})" class="btn btn-sm btn-delete" title="Delete video">
                    Delete
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">üì≠</div>
        <h3>No videos processed yet</h3>
        <p>Upload a video or paste a YouTube URL to get started!</p>
        <a href="/" class="btn btn-primary">Get Started</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<style>
    .btn-delete {
        background: #ef4444;
        color: white;
    }

    .btn-delete:hover {
        background: #dc2626;
    }

    .btn-cancel {
        background: #f59e0b;
        color: white;
    }

    .btn-cancel:hover {
        background: #d97706;
    }

    .error-status {
        color: var(--error-color);
        font-weight: 600;
    }

    .video-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }
</style>

<script>
    // Poll for status updates on processing videos
    const processingVideos = new Set();
    const statusIntervals = {};

    // Find all processing videos on page load
    document.querySelectorAll('.video-card').forEach(card => {
        const videoId = parseInt(card.dataset.videoId);
        const status = card.dataset.status;

        if (status && !['completed', 'failed', 'cancelled'].includes(status)) {
            processingVideos.add(videoId);
            startStatusPolling(videoId);
        }
    });

    function startStatusPolling(videoId) {
        // Poll every 2 seconds
        statusIntervals[videoId] = setInterval(async () => {
            try {
                const response = await fetch(`/status/${videoId}`);
                const status = await response.json();

                updateVideoStatus(videoId, status);

                // Stop polling if complete, failed, or cancelled
                if (['completed', 'failed', 'cancelled'].includes(status.status)) {
                    clearInterval(statusIntervals[videoId]);
                    processingVideos.delete(videoId);

                    // Reload page to show updated content after a short delay
                    setTimeout(() => window.location.reload(), 1000);
                }
            } catch (error) {
                console.error(`Error polling status for video ${videoId}:`, error);
            }
        }, 2000);
    }

    function updateVideoStatus(videoId, status) {
        const card = document.querySelector(`.video-card[data-video-id="${videoId}"]`);
        if (!card) return;

        // More detailed status messages based on progress
        const getStatusMessage = (statusName, progress) => {
            if (statusName === 'extracting') {
                if (progress <= 15) return 'Starting extraction...';
                if (progress <= 25) return 'Extracting audio...';
                return 'Processing metadata...';
            } else if (statusName === 'transcribing') {
                if (progress <= 35) return 'Loading model...';
                if (progress <= 40) return 'Starting transcription...';
                if (progress <= 55) return 'Transcribing audio...';
                return 'Saving transcript...';
            } else if (statusName === 'generating') {
                if (progress <= 70) return 'Analyzing transcript...';
                if (progress <= 80) return 'Generating notes...';
                if (progress <= 90) return 'Formatting notes...';
                return 'Saving notes...';
            } else if (statusName === 'pending') {
                return 'Starting...';
            } else if (statusName === 'completed') {
                return 'Completed';
            } else if (statusName === 'failed') {
                return 'Failed';
            } else if (statusName === 'cancelled') {
                return 'Cancelled';
            }
            return statusName;
        };

        const statusMessage = getStatusMessage(status.status, status.progress || 0);

        // Update status badge
        const statusBadge = card.querySelector('.status-badge');
        if (statusBadge) {
            statusBadge.textContent = status.status.charAt(0).toUpperCase() + status.status.slice(1);
            statusBadge.className = `badge status-badge status-${status.status}`;
        }

        // Update progress bar
        const progressFill = card.querySelector('.progress-fill');
        const progressText = card.querySelector('.progress-text');

        if (progressFill) {
            progressFill.style.width = (status.progress || 0) + '%';
        }

        if (progressText) {
            progressText.textContent = `${status.progress || 0}% ‚Ä¢ ${statusMessage}`;
        }

        // Update title if it changed from "Processing..."
        const titleElement = card.querySelector('.video-title');
        if (titleElement && titleElement.textContent === 'Processing...') {
            // Fetch updated video info
            fetch(`/api/videos`)
                .then(res => res.json())
                .then(videos => {
                    const video = videos.find(v => v.id === videoId);
                    if (video && video.title !== 'Processing...') {
                        titleElement.textContent = video.title;
                    }
                });
        }
    }

    // Clean up intervals when leaving the page
    window.addEventListener('beforeunload', () => {
        Object.values(statusIntervals).forEach(interval => clearInterval(interval));
    });

    // Action functions
    async function cancelProcessing(videoId) {
        if (!confirm('Are you sure you want to cancel processing this video?')) {
            return;
        }

        try {
            const response = await fetch(`/cancel/${videoId}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                alert('Processing cancelled successfully');
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to cancel processing'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function restartProcessing(videoId) {
        if (!confirm('Are you sure you want to restart processing this video?')) {
            return;
        }

        try {
            const response = await fetch(`/restart/${videoId}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                alert('Processing restarted successfully');
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to restart processing'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function deleteVideo(videoId) {
        if (!confirm('Are you sure you want to delete this video and all its data?\n\nThis action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/delete/${videoId}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                // Remove the card from the page with animation
                const card = document.querySelector(`.video-card[data-video-id="${videoId}"]`);
                if (card) {
                    card.style.transition = 'opacity 0.3s ease';
                    card.style.opacity = '0';
                    setTimeout(() => {
                        card.remove();
                        // Check if there are no more videos
                        if (document.querySelectorAll('.video-card').length === 0) {
                            window.location.reload();
                        }
                    }, 300);
                }
            } else {
                alert('Error: ' + (data.error || 'Failed to delete video'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
</script>
{% endblock %}
